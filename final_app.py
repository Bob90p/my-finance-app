import streamlit as st
import yfinance as yf
import google.generativeai as genai

# ุถุน ููุชุงุญู ููุง (ุชุฃูุฏ ูู ุจูุงุก ุนูุงูุงุช ุงูุชูุตูุต)
genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
model = genai.GenerativeModel('gemini-pro')

st.set_page_config(page_title="ุงููุญูู ุงูุงุณุชุฑุงุชูุฌู", layout="wide")
st.title("๐ ุงููุญูู ุงููุงูู ูุงูุณูุงุณู ุงูุนุงููู")

# --- ููุทูุฉ ุงูุฅุฏุฎุงู ---
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("๐ ุงูุจุญุซ ุนู ุฃุตู ูุงูู")
    # ููุง ููููู ูุชุงุจุฉ ุฃู ุฑูุฒ ุณูู ุนุงููู
    ticker = st.text_input("ุงูุชุจ ุฑูุฒ ุงูุณูู ุฃู ุงูุนููุฉ (ูุซุงู: AAPL ูุขุจูุ TSLA ูุชุณูุงุ GC=F ููุฐูุจ):", "AAPL")
    
with col2:
    st.subheader("๐ฌ ุณูุงู ุฅุถุงูู")
    context = st.text_area("ุฃุถู ุฃู ุฃุฎุจุงุฑ ุณูุงุณูุฉ ุชุฑูุฏ ุฑุจุทูุง ุจุงูุชุญููู (ุงุฎุชูุงุฑู):")

    if st.button("๐ ุจุฏุก ุงูุชุญููู ูุงูุญุตูู ุนูู ุงูุชูุตูุฉ"):
        try:
            # 1. ุฌูุจ ุจูุงูุงุช ุงูุณูู
            with st.spinner("...ุฌุงุฑู ุณุญุจ ุงูุจูุงูุงุช ูู ุงูุฃุณูุงู ุงูุนุงูููุฉ"):
                stock = yf.Ticker(ticker)
                info = stock.history(period="5d")
                current_price = info['Close'].iloc[-1]
                
                st.metric(label=f"ุงูุณุนุฑ ุงูุญุงูู ูู {ticker}", value=f"{current_price:.2f}")
                st.line_chart(info['Close'])

            # 2. ุงูุชุญููู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุน ุชุนูููุงุช ุงูุชูุตูุฉ
            with st.spinner("...ูุญูู ุงูุขู ุงููุดูุฏ ุงููุงูู ูุงูุณูุงุณู ุจุฐูุงุก Gemini"):
                # ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุตุงุฑูุฉ ููุชูุตูุฉ
                instruction = """
                ุฃูุช ูุญูู ูุงูู ุฎุจูุฑ. ูู ุจุชุญููู ุงูุจูุงูุงุช ูุงูุฑุณูู ุงูุจูุงููุฉ ููุฐุง ุงูุณูู:
                1. ุงูุชูุตูุฉ ุงูููุงุฆูุฉ: (ุดุฑุงุก / ุจูุน / ุงุญุชูุงุธ) ุจุดูู ุจุงุฑุฒ.
                2. ุงูุฃูุฏุงู: ุญุฏุฏ ุณุนุฑ ุงูุฏุฎูู ุงููุซุงููุ ููุฏู ุงูุฑุจุญ ุงูุฃููุ ูููู ุงูุฎุณุงุฑุฉ.
                3. ุงูุฃุณุจุงุจ: ุงุดุฑุญ ุจุงุฎุชุตุงุฑ ุจูุงุกู ุนูู ุงูุงุชุฌุงู ุงูููู ูุงูุฃุฎุจุงุฑ ุงูุญุงููุฉ.
                ุงุฌุนู ุงูุฑุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูููุธูุงู ุฌุฏุงู.
                """
                
                # ุฏูุฌ ุงูุชุนูููุงุช ูุน ุงูุณูุงู
                full_prompt = f"{instruction}\n\nุงูุณูุงู ุงูุฅุถุงูู ูู ุงููุณุชุฎุฏู: {context}"
                
                # ุฅุฑุณุงู ุงูุทูุจ ูู Gemini
                response = model.generate_content([full_prompt, img])
                
                st.markdown("---")
                st.subheader("๐ ุงูุชูุตูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ:")
                st.write(response.text)

        except Exception as e:
            st.error(f"ุฎุทุฃ: ุชุฃูุฏ ูู ูุชุงุจุฉ ุงูุฑูุฒ ุจุดูู ุตุญูุญ. (e)")
