import streamlit as st
import yfinance as yf
import google.generativeai as genai
from PIL import Image

# 1. ุฅุนุฏุงุฏ ุงูุงุชุตุงู ุจู Gemini ุจุงุณุชุฎุฏุงู Secrets ููุฃูุงู
# ุชุฃูุฏ ุฃูู ูุถุนุช GEMINI_API_KEY ูู ุฅุนุฏุงุฏุงุช Streamlit
genai.configure(api_key=st.secrets["GEMINI_API_KEY"])

# ุงุณุชุฎุฏุงู ููุฏูู 1.5 flash ูุฃูู ุงูุฃูุถู ูู ุชุญููู ุงูุฑุณูู ุงูุจูุงููุฉ
model = genai.GenerativeModel('gemini-1.5-flash')

# ุฅุนุฏุงุฏ ูุงุฌูุฉ ุงูุชุทุจูู
st.set_page_config(page_title="ุงููุญูู ุงูุงุณุชุฑุงุชูุฌู ุงูุฐูู", layout="wide")
st.title("ุงููุญูู ุงููุงูู ูุงูุณูุงุณู ุงูุนุงููู ๐ค๐")

# ููุทูุฉ ุงูุฅุฏุฎุงู
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("๐ ุงูุจุญุซ ุนู ุฃุตู ูุงูู")
    ticker = st.text_input("ุงูุชุจ ุฑูุฒ ุงูุณูู ุฃู ุงูุนููุฉ (ูุซุงู: AAPL, BTC-USD, COMI.CA):", "AAPL")

with col2:
    st.subheader("๐ฌ ุณูุงู ุฅุถุงูู (ุงุฎุชูุงุฑู)")
    context = st.text_area("ุฃุถู ุฃู ุฃุฎุจุงุฑ ุฃู ุงุณุชูุณุงุฑุงุช ูุญุฏุฏุฉ ุชุฑูุฏ ุฑุจุทูุง ุจุงูุชุญููู:")

# ุฒุฑ ุงูุชุดุบูู
if st.button("๐ ุงูุญุตูู ุนูู ุงูุชูุตูุฉ ุงููููุฉ ูุงูุงุณุชุฑุงุชูุฌูุฉ"):
    if ticker:
        try:
            with st.spinner("ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช ูุชุญููู ุงูุฑุณู ุงูุจูุงูู..."):
                # ุฌูุจ ุจูุงูุงุช ุงูุณูู ูู yfinance
                stock = yf.Ticker(ticker)
                df = stock.history(period="1mo") # ุจูุงูุงุช ุดูุฑ ูุงุญุฏ ููุฑุณู ุงูุจูุงูู
                
                if df.empty:
                    st.error("ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ููุฐุง ุงูุฑูุฒ. ุชุฃูุฏ ูู ูุชุงุจุชู ุจุดูู ุตุญูุญ.")
                else:
                    current_price = df['Close'].iloc[-1]
                    
                    # ุนุฑุถ ุงูุณุนุฑ ูุงูุฑุณู ุงูุจูุงูู
                    st.metric(label=f"ุงูุณุนุฑ ุงูุญุงูู ูู {ticker}", value=f"{current_price:.2f}")
                    st.line_chart(df['Close'])
                    
                    # ุญูุธ ุงูุฑุณู ุงูุจูุงูู ูุตูุฑุฉ ูุฅุฑุณุงููุง ูู Gemini
                    import matplotlib.pyplot as plt
                    fig, ax = plt.subplots()
                    df['Close'].plot(ax=ax)
                    plt.title(f"Chart for {ticker}")
                    plt.savefig("chart.png")
                    img = Image.open("chart.png")

                    # ุตูุงุบุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ (ุงูุจุฑููุจุช)
                    instruction = f"""
                    ุฃูุช ูุญูู ูุงูู ุฎุจูุฑ. ูู ุจุชุญููู ูุฐุง ุงูุณูู {ticker} ุจูุงุกู ุนูู ุงูุฑุณู ุงูุจูุงูู ุงููุฑูู:
                    1. ุงูุชูุตูุฉ ุงูููุงุฆูุฉ: (ุดุฑุงุก / ุจูุน / ุงุญุชูุงุธ) ุจุดูู ูุงุถุญ ูุฌุฑูุก.
                    2. ูุณุชููุงุช ุงูุณุนุฑ: ุญุฏุฏ ุณุนุฑ ุงูุฏุฎูู ุงูููุงุณุจุ ูุงููุฏู ุงููุชููุนุ ูููุทุฉ ููู ุงูุฎุณุงุฑุฉ.
                    3. ุงูุชุญููู ุงูููู: ุงุดุฑุญ ุจุงุฎุชุตุงุฑ ุงูุงุชุฌุงู ุงูุญุงูู (ุตุงุนุฏ/ูุงุจุท) ูุฃูู ููุงุท ุงูุฏุนู ูุงูููุงููุฉ.
                    4. ููุงุญุธุงุช ุฅุถุงููุฉ: {context if context else 'ูุง ููุฌุฏ ุณูุงู ุฅุถุงูู ูู ุงููุณุชุฎุฏู.'}
                    ุงุฌุนู ุงูุฑุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉุ ููุธูุงู ูู ููุงุทุ ููุจุงุดุฑุงู ุฌุฏุงู.
                    """

                    # ุฅุฑุณุงู ุงูุตูุฑุฉ ูุงูุชุนูููุงุช ูู Gemini
                    response = model.generate_content([instruction, img])
                    
                    st.markdown("---")
                    st.success("โ ุชู ุงูุงูุชูุงุก ูู ุงูุชุญููู")
                    st.subheader("๐ ุงูุชูุตูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ:")
                    st.write(response.text)
                    
        except Exception as e:
            st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ: {e}")
    else:
        st.error("ูู ูุถูู ุฃุฏุฎู ุฑูุฒ ุงูุณูู ุฃููุงู.")
