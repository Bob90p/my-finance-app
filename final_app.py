import streamlit as st
import yfinance as yf
import google.generativeai as genai

# 1. ุฅุนุฏุงุฏ ุงูุตูุญุฉ ูุงูููุชุงุญ
st.set_page_config(page_title="ุงููุญูู ุงููุงูู ุงููุตู", layout="wide")

if "GEMINI_API_KEY" in st.secrets:
    api_key = st.secrets["GEMINI_API_KEY"].strip()
    genai.configure(api_key=api_key)
    # ุงุณุชุฎุฏุงู ููุฏูู ููุงุด ุงูุณุฑูุน
    model = genai.GenerativeModel('gemini-1.5-flash')
else:
    st.error("โ๏ธ ูุฑุฌู ุถุจุท ุงูููุชุงุญ ูู Secrets")
    st.stop()

st.title("ุงููุญูู ุงููุงูู ุงูุฐูู (ูุณุฎุฉ ุชุญููู ุงูุจูุงูุงุช) ๐ค๐")

ticker = st.text_input("ุฃุฏุฎู ุฑูุฒ ุงูุณูู (ูุซู CASE ุฃู AAPL):", "CASE")

if st.button("๐ ุชุญููู ุงูุณูู ุงูุขู"):
    try:
        with st.spinner("ุฌุงุฑู ุฌูุจ ูุชุญููู ุงูุจูุงูุงุช ุงูุฑูููุฉ..."):
            # ุฌูุจ ุจูุงูุงุช ุดูุฑ ูุงูู ูุชุญููู ุงูุงุชุฌุงู
            stock = yf.Ticker(ticker)
            df = stock.history(period="1mo")
            
            if not df.empty:
                # ุชุญุถูุฑ ุงูุจูุงูุงุช ุงูุฑูููุฉ ูุชุญููููุง ููุต ููููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                last_price = df['Close'].iloc[-1]
                high_price = df['High'].max()
                low_price = df['Low'].min()
                change = ((last_price - df['Close'].iloc[0]) / df['Close'].iloc[0]) * 100
                
                # ุนุฑุถ ุงูุณุนุฑ ุงูุญุงูู ูู ุงููุงุฌูุฉ
                st.metric(f"ุงูุณุนุฑ ุงูุญุงูู ({ticker})", f"{last_price:.2f}", f"{change:.2f}%")
                
                # ุตูุงุบุฉ ุงูุทูุจ ุงููุตู ููุท (ุจุฏูู ุตูุฑ)
                prompt = f"""
                ุจุตูุชู ูุญูู ูุงููุ ุญูู ุฃุฏุงุก ุณูู {ticker} ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูุชุงููุฉ ูุดูุฑ ูุถู:
                - ุงูุณุนุฑ ุงูุญุงูู: {last_price:.2f}
                - ุฃุนูู ุณุนุฑ ูุตู ูู: {high_price:.2f}
                - ุฃุฏูู ุณุนุฑ ูุตู ูู: {low_price:.2f}
                - ูุณุจุฉ ุงูุชุบูุฑ ุงูุฅุฌูุงููุฉ: {change:.2f}%
                
                ุฃุนุทูู ุชูุตูุฉ (ุดุฑุงุกุ ุจูุนุ ุฃู ุงุญุชูุงุธ) ูุน ุฐูุฑ ุงูุฃูุฏุงู ุงููุชููุนุฉ ูููู ุงูุฎุณุงุฑุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.
                """
                
                # ุฅุฑุณุงู ุงูุทูุจ ุงููุตู
                response = model.generate_content(prompt)
                
                st.markdown("---")
                st.subheader("๐ ุงูุชูุตูุฉ ุงููููุฉ (ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูุฑูููุฉ):")
                st.success(response.text)
            else:
                st.error("โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ููุฐุง ุงูุฑูุฒ.")
                
    except Exception as e:
        # [span_0](start_span)ุงูุณุฌูุงุช ุฃุธูุฑุช ุฃุฎุทุงุก ูู ุงูู headerุ ูุฐุง ูุธูุฑ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู[span_0](end_span)
        st.error(f"ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู: {e}")
        st.info("ุชุฃูุฏ ูู ุตุญุฉ ููุชุงุญ API ูู ุงูุฅุนุฏุงุฏุงุช.")
