import streamlit as st
import yfinance as yf
import google.generativeai as genai
from PIL import Image
import matplotlib.pyplot as plt

# 1. ุฅุนุฏุงุฏ ุงูุงุชุตุงู ุจู Gemini ุจุงุณุชุฎุฏุงู Secrets ููุฃูุงู
try:
    # ุณูููู ุงูุชุทุจูู ุจูุฑุงุกุฉ ุงูููุชุงุญ ูู ุตูุญุฉ Secrets ูู Streamlit
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
    # ุงุณุชุฎุฏุงู ููุฏูู 1.5 flash ูุฃูู ูุฏุนู ุงูุตูุฑ ูุฃุณุฑุน ูู ุงูุชูุตูุงุช
    model = genai.GenerativeModel('gemini-1.5-flash')
except Exception as e:
    st.error("โ๏ธ ุฎุทุฃ ูู ุฅุนุฏุงุฏ ููุชุงุญ API. ุชุฃูุฏ ูู ุฅุถุงูุชู ูู ุฅุนุฏุงุฏุงุช Secrets ุจุงุณู GEMINI_API_KEY")

# ุฅุนุฏุงุฏ ูุงุฌูุฉ ุงูุชุทุจูู
st.set_page_config(page_title="ุงููุญูู ุงูุงุณุชุฑุงุชูุฌู ุงูุฐูู", layout="wide")
st.title("ุงููุญูู ุงููุงูู ูุงูุณูุงุณู ุงูุนุงููู ๐ค๐")

# ููุทูุฉ ุงูุฅุฏุฎุงู
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("๐ ุงูุจุญุซ ุนู ุฃุตู ูุงูู")
    ticker = st.text_input("ุงูุชุจ ุฑูุฒ ุงูุณูู (ูุซุงู: AAPL, BTC-USD, COMI.CA, CASE):", "CASE")
    st.caption("ููุงุญุธุฉ: ุงุณุชุฎุฏู CASE ููุคุดุฑ ุงูุจูุฑุตุฉ ุงููุตุฑูุฉ ุงูุฑุฆูุณู.")

with col2:
    st.subheader("๐ฌ ุณูุงู ุฅุถุงูู (ุงุฎุชูุงุฑู)")
    context = st.text_area("ุฃุถู ุฃู ุฃุฎุจุงุฑ ุฃู ุงุณุชูุณุงุฑุงุช ูุญุฏุฏุฉ ุชุฑูุฏ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุฑุงุนุงุชูุง:")

# ุฒุฑ ุงูุชุดุบูู
if st.button("๐ ุงูุญุตูู ุนูู ุงูุชูุตูุฉ ุงููููุฉ ูุงูุงุณุชุฑุงุชูุฌูุฉ"):
    if ticker:
        try:
            with st.spinner("ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช ูุชุญููู ุงูุฑุณู ุงูุจูุงูู..."):
                # ุฌูุจ ุงูุจูุงูุงุช
                stock = yf.Ticker(ticker)
                df = stock.history(period="1mo")
                
                if df.empty:
                    st.error("โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ููุฐุง ุงูุฑูุฒ. ุชุฃูุฏ ูู ูุชุงุจุชู ุจุดูู ุตุญูุญ (ูุซู COMI.CA ููุจูู ุงูุชุฌุงุฑู ุงูุฏููู).")
                else:
                    current_price = df['Close'].iloc[-1]
                    st.metric(label=f"ุงูุณุนุฑ ุงูุญุงูู ูู {ticker}", value=f"{current_price:.2f}")
                    
                    # ุฅูุดุงุก ุงูุฑุณู ุงูุจูุงูู
                    fig, ax = plt.subplots(figsize=(10, 5))
                    df['Close'].plot(ax=ax, color='#1f77b4', linewidth=2)
                    ax.set_title(f"Performance Chart: {ticker}")
                    ax.grid(True, linestyle='--', alpha=0.7)
                    st.pyplot(fig)
                    
                    # ุญูุธ ุงูุฑุณู ูุตูุฑุฉ ูุชุญููููุง ุจูุงุณุทุฉ Gemini
                    fig.savefig("chart.png")
                    img = Image.open("chart.png")

                    # ุชุนูููุงุช ุงูุชูุตูุฉ (ุงูุจุฑููุจุช ุงูุงุญุชุฑุงูู)
                    instruction = f"""
                    ุฃูุช ูุญูู ูุงูู ุงุณุชุฑุงุชูุฌู ุฎุจูุฑ. ูู ุจุชุญููู ุงูุฑุณู ุงูุจูุงูู ุงููุฑูู ูู {ticker}:
                    1. ุงูุชูุตูุฉ ุงูููุงุฆูุฉ: ุฃุนุทู ูุฑุงุฑุงู ูุงุถุญุงู (ุดุฑุงุก / ุจูุน / ุงุญุชูุงุธ / ูุฑุงูุจุฉ).
                    2. ูุณุชููุงุช ุงูุณุนุฑ: ุญุฏุฏ (ููุทุฉ ุงูุฏุฎูู ุงููุซุงููุฉ)ุ (ุงููุฏู ุงูุฃูู)ุ ู(ููู ุงูุฎุณุงุฑุฉ).
                    3. ุงูุชุญููู ุงูููู: ุงุดุฑุญ ุจุงุฎุชุตุงุฑ ุงูุงุชุฌุงู (ุตุงุนุฏ/ูุงุจุท) ุจูุงุกู ุนูู ุงูุฑุณู.
                    4. ุงูุณูุงู ุงูุฎุงุต ุจุงููุณุชุฎุฏู: {context if context else 'ูุง ููุฌุฏ ุฅุถุงูุงุช ูุญุฏุฏุฉ.'}
                    ุงุฌุนู ุงูุฑุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉุ ููุธูุงู ูู ููุงุทุ ููุจุงุดุฑุงู.
                    """

                    # ุฅุฑุณุงู ุงูุตูุฑุฉ ูุงูุชุนูููุงุช ูู Gemini
                    response = model.generate_content([instruction, img])
                    
                    st.markdown("---")
                    st.success(f"โ ุชู ุงูุงูุชูุงุก ูู ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู ูู {ticker}")
                    st.subheader("๐ ุงูุชูุตูุฉ ุงููููุฉ:")
                    st.write(response.text)
                    
        except Exception as e:
            st.error(f"ุญุฏุซ ุฎุทุฃ ุชููู: {e}")
    else:
        st.error("ุฑุฌุงุกู ุฃุฏุฎู ุฑูุฒ ุงูุณูู ุฃููุงู.")
